<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>DeepStream Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div id="layout">
    <!-- LEFT: controls + events/logs -->
    <section id="left">
      <h1>DeepStream Control Panel</h1>
      <div id="status" class="muted">status: loadingâ€¦</div>

      <div class="card">
        <div class="title">Deployment</div>

        <label>MQTT topic</label>
        <input id="topic" value="ds/events" disabled>

        <label>DeepStream config</label>
        <input id="cfg" value="/home/lain/DeepStream-Yolo-master/Deepstream_example_usb.txt" disabled>

        <div class="row">
          <button id="btnStart">Start</button>
          <button id="btnStop" class="secondary">Stop</button>
          <button id="btnRefresh" class="secondary">Refresh</button>
          <button id="btnSim" class="accent" title="Trigger a fake detection">Simulate alert</button>
        </div>
        <small class="muted">Simulate alert works even without any real detections.</small>
      </div>

      <details id="eventsBox" open>
        <summary>Events</summary>
        <div id="events"></div>
      </details>

      <details id="logsBox">
        <summary>Logs</summary>
        <pre id="logs"></pre>
      </details>
    </section>

    <!-- RIGHT: visual alerts -->
    <section id="right">
      <div id="right-top" class="panel">
        <div class="panel-title">Alert Light</div>
        <div id="redLightWrap">
          <div id="redLight"></div>
          <div id="redText" class="muted">ready</div>
        </div>
      </div>

      <div id="right-bottom" class="panel">
        <div class="panel-title">Speaker</div>
        <div id="speakerWrap">
          <div id="speakerIcon" aria-hidden="true">ðŸ”Š</div>
          <div id="beepText" class="muted">waitingâ€¦</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------- API helper ----------
    async function api(path, method='GET', body=null){
      const res = await fetch(path,{method,headers:{'Content-Type':'application/json'},body:body?JSON.stringify(body):null});
      if(!res.ok) throw new Error(await res.text());
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    // ---------- DOM refs ----------
    const statusEl = document.getElementById('status');
    const eventsEl = document.getElementById('events');
    const logsEl   = document.getElementById('logs');
    const redLight = document.getElementById('redLight');
    const redText  = document.getElementById('redText');
    const beepText = document.getElementById('beepText');

    // ---------- Buttons ----------
    document.getElementById('btnStart').onclick   = ()=>api('/start','POST').then(renderStatus);
    document.getElementById('btnStop').onclick    = ()=>api('/stop','POST').then(renderStatus);
    document.getElementById('btnRefresh').onclick = ()=>renderStatus();
    document.getElementById('btnSim').onclick     = ()=>{
      // Simulated event: update visuals + append a fake event
      triggerVisuals({label:'sim', confidence:1});
      const now = new Date().toISOString();
      const e = {label:'sim', confidence:1, bbox:{left:10,top:10,right:110,bottom:80}, track_id:'sim', timestamp:now, _seq:`sim-${now}`};
      renderEvents([...(window._lastEvents||[]), e].slice(-30));
      window._lastSeq = e._seq;
    };

    // ---------- Renderers ----------
    function renderStatus(st){
      if(!st) return api('/status').then(renderStatus);
      statusEl.textContent = `status: ${st.running ? 'running' : 'stopped'}  pid: ${st.pid ?? 'â€”'}`;
    }

    function renderEvents(list){
      window._lastEvents = list;
      eventsEl.innerHTML = '';
      for(const e of list){
        const pct = e.confidence!=null ? Math.round(e.confidence*1000)/10+'%' : '';
        const bb = e.bbox||{};
        const div = document.createElement('div');
        div.className = 'event';
        div.innerHTML = `
          <div class="head">
            <b>${e.label||'object'}</b>
            <span class="muted">${pct}</span>
            <span class="muted">bbox: (${bb.left??'?'},${bb.top??'?'})â€”(${bb.right??'?'},${bb.bottom??'?'})</span>
            <span class="time">${(e.timestamp||'').slice(11,19)}</span>
          </div>`;
        eventsEl.appendChild(div);
      }
    }

    function renderLogs(text){
      logsEl.textContent = typeof text === 'string' ? text : (text && text.text) || '';
    }

    // ---------- Visual reactions ----------
    function flashRed(text='Detection', ms=320){
      redLight.classList.add('on');
      redText.textContent = text;
      setTimeout(()=>redLight.classList.remove('on'), ms);
    }
    function pulseBEEP(text='BEEP!', ms=320){
      beepText.textContent = text;
      beepText.classList.add('boom');
      setTimeout(()=>{
        beepText.classList.remove('boom');
        beepText.textContent = 'waitingâ€¦';
      }, ms);
    }

    // optional WebAudio (used if output is available)
    let audioCtx;
    function beep(ms=120, freq=880){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = freq; o.start();
        g.gain.setValueAtTime(0.25, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + ms/1000);
        o.stop(audioCtx.currentTime + ms/1000);
      }catch{} // no audio device? no problem â€” we still show BEEP text.
    }

    function triggerVisuals(evt){
      const pct = evt.confidence!=null ? Math.round(evt.confidence*100) : null;
      flashRed(`${evt.label||'object'} ${pct??''}%`);
      pulseBEEP('BEEP!', 340);
      beep(140, 880);
    }

    // ---------- Poll loop ----------
    let _lastSeq = null;
    async function tick(){
      try{
        const evts = await api('/events?limit=30');
        renderEvents(evts);
        const newest = evts[evts.length-1];
        const seq = newest ? (newest._seq ?? JSON.stringify(newest)) : null;
        if(seq && seq !== _lastSeq){
          _lastSeq = seq;
          triggerVisuals(newest||{});
        }
      }catch(e){}

      try{
        const lg = await api('/logs?pretty=false');
        renderLogs(lg);
      }catch(e){}

      setTimeout(tick, 1000);
    }

    renderStatus();
    tick();
  </script>
</body>
</html>

