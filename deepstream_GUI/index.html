<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>DeepStream Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Uses your external stylesheet -->
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div id="layout">
    <!-- LEFT: settings + PTZ + events + logs -->
    <section id="left">
      <h1>DeepStream Control Panel</h1>
      <div id="status" class="muted">status: loading‚Ä¶</div>

      <!-- Deployment (unchanged) -->
      <div class="card">
        <div class="title">Deployment</div>
        <label>MQTT topic</label>
        <input id="topic" value="ds/events" disabled>
        <label>DeepStream config</label>
        <input id="cfg" value="/home/lain/DeepStream-Yolo-master/Deepstream_example_usb.txt" disabled>
        <div class="row">
          <button id="btnStart">Start</button>
          <button id="btnStop" class="secondary">Stop</button>
          <button id="btnRefresh" class="secondary">Refresh</button>
          <button id="btnSim" class="accent" title="Trigger a fake detection">Simulate alert</button>
        </div>
        <small class="muted">‚ÄúSimulate alert‚Äù tests the right-side light + beep without real detections.</small>
      </div>

      <!-- PTZ CONTROL (minimal, non-intrusive) -->
      <div class="card">
        <div class="title">Camera Control (PTZ)</div>
        <div class="ptz-grid">
          <button class="ptz-btn" data-code="LeftUp">‚Üñ</button>
          <button class="ptz-btn" data-code="Up">‚Üë</button>
          <button class="ptz-btn" data-code="RightUp">‚Üó</button>

          <button class="ptz-btn" data-code="Left">‚Üê</button>
          <button class="ptz-btn" data-code="stop_all" title="Stop">‚ñ†</button>
          <button class="ptz-btn" data-code="Right">‚Üí</button>

          <button class="ptz-btn" data-code="LeftDown">‚Üô</button>
          <button class="ptz-btn" data-code="Down">‚Üì</button>
          <button class="ptz-btn" data-code="RightDown">‚Üò</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="ptz-zoom" data-code="ZoomWide">Zoom ‚àí</button>
          <input id="ptzSpeed" type="range" min="0" max="8" value="3" style="flex:1">
          <button class="ptz-zoom" data-code="ZoomTele">Zoom +</button>
        </div>

        <details style="margin-top:10px">
          <summary>PTZ Config</summary>
          <div class="row" style="gap:10px; margin-top:8px">
            <input id="ptzHost" placeholder="host/IP" style="flex:1">
            <input id="ptzUser" placeholder="user" style="width:140px">
            <input id="ptzPass" placeholder="password" type="password" style="width:160px">
            <input id="ptzChan" placeholder="ch" type="number" min="1" value="1" style="width:80px">
            <button id="ptzSave" class="secondary">Save</button>
          </div>
        </details>
      </div>

      <!-- Events / Logs (unchanged) -->
      <details id="eventsBox" open>
        <summary>Events</summary>
        <div id="events"></div>
      </details>

      <details id="logsBox">
        <summary>Logs</summary>
        <pre id="logs"></pre>
      </details>
    </section>

    <!-- RIGHT: split vertically (top = RED light, bottom = speaker ‚ÄúBEEP!‚Äù) -->
    <section id="right">
      <div class="panel">
        <div class="panel-title">Alert Light</div>
        <div id="redLightWrap">
          <div id="redLight"></div>
          <div id="redText" class="muted">ready</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Speaker</div>
        <div id="speakerWrap">
          <div id="speakerIcon" aria-hidden="true">üîä</div>
          <div id="beepText" class="muted">waiting‚Ä¶</div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---- tiny fetch helper ----
    async function api(path, method='GET', body=null){
      const res = await fetch(path,{method,headers:{'Content-Type':'application/json'},body:body?JSON.stringify(body):null});
      if(!res.ok) throw new Error(await res.text());
      const ct = res.headers.get('content-type')||'';
      return ct.includes('application/json') ? res.json() : res.text();
    }

    // ---- DOM refs ----
    const statusEl = document.getElementById('status');
    const eventsEl = document.getElementById('events');
    const logsEl   = document.getElementById('logs');
    const redLight = document.getElementById('redLight');
    const redText  = document.getElementById('redText');
    const beepText = document.getElementById('beepText');

    // ---- deployment buttons (unchanged) ----
    document.getElementById('btnStart').onclick   = ()=>api('/start','POST').then(renderStatus);
    document.getElementById('btnStop').onclick    = ()=>api('/stop','POST').then(renderStatus);
    document.getElementById('btnRefresh').onclick = ()=>renderStatus();
    document.getElementById('btnSim').onclick     = ()=>{
      triggerVisuals({label:'sim', confidence:1});
      const now = new Date().toISOString();
      const e = {label:'sim', confidence:1, bbox:{left:10,top:10,right:110,bottom:80}, track_id:'sim', timestamp:now, _seq:`sim-${now}`};
      renderEvents([...(window._lastEvents||[]), e].slice(-30));
      window._lastSeq = e._seq;
    };

    // ---- renderers (unchanged) ----
    function renderStatus(st){
      if(!st) return api('/status').then(renderStatus);
      statusEl.textContent = `status: ${st.running ? 'running' : 'stopped'}  pid: ${st.pid ?? '‚Äî'}`;
    }
    function renderEvents(list){
      window._lastEvents = list;
      eventsEl.innerHTML = '';
      for(const e of list){
        const pct = e.confidence!=null ? Math.round(e.confidence*1000)/10+'%' : '';
        const bb = e.bbox||{};
        const div = document.createElement('div');
        div.className = 'event';
        div.innerHTML = `
          <div class="head">
            <b>${e.label||'object'}</b>
            <span class="muted">${pct}</span>
            <span class="muted">bbox: (${bb.left??'?'},${bb.top??'?'})‚Äî(${bb.right??'?'},${bb.bottom??'?'})</span>
            <span class="time">${(e.timestamp||'').slice(11,19)}</span>
          </div>`;
        eventsEl.appendChild(div);
      }
    }
    function renderLogs(text){
      logsEl.textContent = typeof text === 'string' ? text : (text && text.text) || '';
    }

    // ---- right-side visuals (unchanged) ----
    function flashRed(text='Detection', ms=320){
      redLight.classList.add('on');
      redText.textContent = text;
      setTimeout(()=>redLight.classList.remove('on'), ms);
    }
    function pulseBeepText(text='BEEP!', ms=340){
      beepText.textContent = text;
      beepText.classList.add('boom');
      setTimeout(()=>{
        beepText.classList.remove('boom');
        beepText.textContent = 'waiting‚Ä¶';
      }, ms);
    }
    let audioCtx;
    function beep(ms=140, freq=880){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = freq; o.start();
        g.gain.setValueAtTime(0.25, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + ms/1000);
        o.stop(audioCtx.currentTime + ms/1000);
      }catch{} // no audio device? still shows the big ‚ÄúBEEP!‚Äù text.
    }
    function triggerVisuals(evt){
      const pct = evt.confidence!=null ? Math.round(evt.confidence*100) : null;
      flashRed(`${evt.label||'object'} ${pct??''}%`);
      pulseBeepText('BEEP!', 340);
      beep(140, 880);
    }

    // ---- PTZ JS (new) ----
    async function ptzStart(code, speed){
      if(code === 'stop_all') return api('/ptz/stop_all','POST');
      return api('/ptz/start','POST', {code, speed});
    }
    async function ptzStop(code){
      if(code === 'stop_all') return api('/ptz/stop_all','POST');
      return api('/ptz/stop','POST', {code});
    }
    function bindHoldToPTZ(selector){
      const speedEl = document.getElementById('ptzSpeed');
      const btns = document.querySelectorAll(selector);
      btns.forEach(btn=>{
        const code = btn.dataset.code;
        const start = e => { e.preventDefault(); btn.classList.add('active'); ptzStart(code, Number(speedEl.value)); };
        const stop  = e => { e.preventDefault(); btn.classList.remove('active'); ptzStop(code); };
        btn.addEventListener('mousedown', start);
        btn.addEventListener('mouseup', stop);
        btn.addEventListener('mouseleave', stop);
        btn.addEventListener('touchstart', start, {passive:false});
        btn.addEventListener('touchend', stop, {passive:false});
        btn.addEventListener('touchcancel', stop, {passive:false});
      });
      // safety: stop all if tab blurs
      window.addEventListener('blur', ()=>api('/ptz/stop_all','POST').catch(()=>{}));
      document.addEventListener('visibilitychange', ()=>{
        if (document.hidden) api('/ptz/stop_all','POST').catch(()=>{});
      });
    }
    bindHoldToPTZ('.ptz-btn');
    bindHoldToPTZ('.ptz-zoom');

    // Load/save PTZ config to server
    (async ()=>{
      try{
        const cfg = await api('/ptz/config');
        document.getElementById('ptzHost').value = cfg.host || '';
        document.getElementById('ptzUser').value = cfg.user || '';
        document.getElementById('ptzChan').value = cfg.channel || 1;
      }catch{}
    })();
    document.getElementById('ptzSave').onclick = async ()=>{
      const host = document.getElementById('ptzHost').value.trim();
      const user = document.getElementById('ptzUser').value.trim();
      const password = document.getElementById('ptzPass').value;
      const channel = Number(document.getElementById('ptzChan').value||1);
      await api('/ptz/config','POST',{host,user,password,channel,timeout:2.5});
      alert('PTZ config saved.');
    };

    // ---- poll loop (unchanged) ----
    let _lastSeq = null;
    async function tick(){
      try{
        const evts = await api('/events?limit=30');
        renderEvents(evts);
        const newest = evts[evts.length-1];
        const seq = newest ? (newest._seq ?? JSON.stringify(newest)) : null;
        if(seq && seq !== _lastSeq){
          _lastSeq = seq;
          triggerVisuals(newest||{});
        }
      }catch(e){}

      try{
        const lg = await api('/logs?pretty=false');
        renderLogs(lg);
      }catch(e){}

      setTimeout(tick, 1000);
    }
    renderStatus(); tick();
  </script>
</body>
</html>

